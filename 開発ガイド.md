# PDF Watcher 開発ガイド

**最終更新**: 2025-06-26
**プロジェクトステータス**: 🎉 完成（全機能実装・全テスト完了・履歴保存機能追加）

## 📋 現在の進捗状況

TODOリスト（pdfwatcher_TODO.md）を常に確認・更新しながら開発を進めてください。

### ✅ 完了済み
1. プロジェクト初期設定
2. 共通コア開発（インターフェース、モデル、型定義）
3. サーバーライブラリ実装（Infrastructure層、Domain層）
4. クライアントGAS実装
5. Chrome拡張開発
6. スプレッドシート作成
7. 初期設定スクリプト作成
8. サーバーライブラリのデプロイ
9. クライアントGASのデプロイ
10. マスターGASプロジェクトをclasp管理に移行
11. Chrome拡張のビルドシステム構築（esbuild導入）
12. **GAS互換性のためのコード構造変更（2025/06/17）**
    - import/export文を削除し、グローバル変数形式に変更
    - ファイル名にプレフィックスを追加（c-, s-, m-）
    - TypeScriptターゲットをES5に変更
13. **スプレッドシートヘッダーの日本語化（2025/06/17）**
    - すべてのシートヘッダーを日本語に変更
    - 英語版ヘッダーマッピングファイル作成
14. **PDFステータスフィールド機能実装（2025/06/21）**
    - ArchivePDFシートに「ステータス」「削除確認日時」列を追加
    - 削除されたPDFの追跡を可能に
15. **6分実行時間制限対策実装（2025/06/22）**
    - 30ページ/グループ、5ページ/ミニバッチ処理
    - 自動中断・再開機構
    - トリガーによる継続処理
    - ProcessingStateによる状態管理
16. **全テスト完了（2025/06/23〜25）**
    - 200件のテスト項目100%達成
    - 6分制限対策の19件のテストケース実施
    - 1000ページ（約50,000 PDF）のボリュームテスト成功
17. **Changes履歴保存機能実装（2025/06/26）**
    - 処理完了時に前回のChangesデータを自動保存
    - 5日間の履歴保持（古いデータは自動削除）
    - 日本語URLサポート
    - 6分制限での中断時は転写されない設計

### 🚀 実装完了（2025/06/18）
1. ✅ 動作確認テスト完了
   - Chrome拡張機能：正常動作
   - 差分検知：新規・変更を正確に検出
   - 複数ページ監視：同時処理可能
   - 定期実行：トリガー設定完了
   - エラーハンドリング：URLチェックなし（仕様）
2. ✅ Changesシート改善
   - 1行1URLの縦並び形式
   - コピペしやすいレイアウト
3. ✅ BatchResult拡張
   - diffResultsフィールド追加
   - 詳細情報を一度に取得

### 🚀 パフォーマンス最適化実装（2025/06/20）
1. ✅ ページハッシュ値による高速化
   - ページ内容が変更されていない場合は差分検出をスキップ
   - 大量URL処理時のパフォーマンスを大幅改善
   - PageSummaryシートに最新ハッシュ値を保存
2. ✅ ハッシュ値の管理方式
   - 世代管理を廃止し、最新のハッシュ値のみを保持
   - シート構造: `PageURL | LastHash | Run-1 Date | ...`
   - DiffServiceで前回ハッシュと比較して早期リターン

### 🎆 プロジェクト完成（2025/06/26）
1. ✅ すべての機能実装完了
   - 基本機能（PDF監視・差分検出）
   - PDFステータス管理
   - 6分実行時間制限対策
   - パフォーマンス最適化
   - Changes履歴保存機能
2. ✅ 全テスト完了
   - テストカバレッジ100%達成
   - パフォーマンス: 1.8-2秒/ページ
   - 最大処理能力: 150-180ページ/6分
   - 履歴保存性能: 10,000件を4.3秒で転写

## 🔧 環境情報

### Google リソース
| リソース | ID/URL | 状態 |
|---------|--------|------|
| PDF_Watcher_Master | [1Sk2Z2eDbj-LRspGzIB4zg6X1ERNELdUz3TdWwEZEUa0](https://docs.google.com/spreadsheets/d/1Sk2Z2eDbj-LRspGzIB4zg6X1ERNELdUz3TdWwEZEUa0/edit) | ✅ 初期設定済み |
| PDF_Watcher_Client_Template | [16U9YPSGOOmp9ahTNpkVvpMwDjcoZ0iryBB9WKdhZJ04](https://docs.google.com/spreadsheets/d/16U9YPSGOOmp9ahTNpkVvpMwDjcoZ0iryBB9WKdhZJ04/edit) | ✅ 作成済み |
| Master GAS Script | 17caTA6pp3A-66WwdvXZWd8i9HDe-MMJrm_ODvkK-jUsTV0G5HfrroXC0 | ✅ clasp管理 |
| Client GAS Script | 18r9JpA-m18Uq5Z4UW58T8bCcjSmanGFtQHr7FyIQFgoUdkZftFeaEFLt | ✅ 履歴保存機能実装済み |
| PDF_Watcher_ServerLib | 14oyw3dxeRB04LpXdn9fsU45V1QZ_rJsEwBZ-2PRNSsSIIMb-kyYbO0tM | ✅ ステータス管理実装済み |

### 設定ファイルの更新状況
- ✅ server-gas/.clasp.json - scriptId設定済み
- ✅ client-gas/.clasp.json - scriptId設定済み
- ✅ client-gas/src/config.ts - MASTER_SPREADSHEET_ID設定済み
- ✅ client-gas/src/config.ts - SERVER_LIBRARY_ID設定済み（AKfycbzjRwtPTCkHPy-D54w0ZDXgfctL89-FO82keskf5XFr81BUnETtDEFVTDEuXIwuuSRX）
- ✅ master-gas/.clasp.json - scriptId設定済み

## 📚 プロジェクト構成

```
pdfwatccher/
├── 📄 要件定義書.md          # 要件定義（変更不可）
├── 📄 pdfwatcher_design.md   # 設計書
├── 📄 pdfwatcher_TODO.md     # TODOリスト（完了）
├── 📄 開発ガイド.md          # このファイル
├── 📄 README.md              # プロジェクト概要
├── 📑 docs/                  # ドキュメント
│   ├── test/                # テスト関連ドキュメント
│   ├── TODOリスト/          # TODOドキュメント
│   │   ├── initial-implementation_TODO.md  # 初期実装ログ（旧：実装状況メモ.md）
│   │   └── *.md            # 各機能のTODOリスト
│   └── *.md                 # 各種仕様書・設計書
├── 📁 core/                  # 共通コア
├── 📁 server-gas/            # サーバーライブラリ
├── 📁 client-gas/            # クライアントGAS
├── 📁 master-gas/            # マスターGAS（clasp管理）
└── 📁 extension/             # Chrome拡張
```

### 📂 ドキュメント整理について

プロジェクト完成に伴い、以下のドキュメント整理を実施しました：

1. **ファイルの移動・リネーム**
   - `実装状況メモ.md` → `docs/TODOリスト/initial-implementation_TODO.md`（初期実装ログとして保存）

2. **Fixedプレフィックスの使用**
   - テスト関連ドキュメントの最終版に`Fixed_`プレフィックスを付与
   - 例：`test-design.md` → `Fixed_test-design.md`

## 📝 コーディング規約（重要）

### Google Apps Script (GAS) プロジェクト

**重要:** GASプロジェクトではimport/export文は使用できません。

1. **ファイル命名規則**
   - クライアント側: `c-XX-機能名.ts` (例: `c-01-parser.ts`)
   - サーバー側: `s-XX-機能名.ts` (例: `s-00-globals.ts`)
   - マスター側: `m-機能名.ts` (例: `m-setup.ts`)
   - 番号順に読み込まれるため、依存関係を考慮して番号を付ける

2. **グローバル変数形式**
   ```typescript
   // ❌ 使用不可
   export class MyClass { }
   import { Something } from './other';
   
   // ✅ 使用可能
   class MyClass { }  // グローバルスコープ
   function myFunction() { }  // グローバル関数
   ```

3. **TypeScript設定**
   - target: ES5（GAS互換性のため）
   - module: none（import/export無効化）

## 🚀 デプロイ手順

### 1. スプレッドシートの初期設定

`setup-scripts`フォルダに初期設定用のGoogle Apps Scriptが用意されています。

#### PDF_Watcher_Master（中央ブック）の初期設定
```bash
cd master-gas
clasp push
```
1. [PDF_Watcher_Master GAS](https://script.google.com/home/projects/17caTA6pp3A-66WwdvXZWd8i9HDe-MMJrm_ODvkK-jUsTV0G5HfrroXC0/edit)を開く
2. `setupMasterSpreadsheet`関数を実行
3. 初回は権限承認が必要

#### PDF_Watcher_Client_Template（クライアントテンプレート）の初期設定
1. [PDF_Watcher_Client_Template](https://docs.google.com/spreadsheets/d/16U9YPSGOOmp9ahTNpkVvpMwDjcoZ0iryBB9WKdhZJ04/edit)を開く
2. メニューから「PDF Watcher」→「初期設定」
3. Summaryシートを開いてIMPORTRANGEを承認

**作成されるシート:**
- Master: ArchivePDF, PageHistory, PageSummary, RunLog（すべて日本語ヘッダー）
- Client: Current（ヘッダーなし）, Changes, ChangesHistory, Summary, UserLog（日本語ヘッダー）

**ヘッダーの言語:**
- すべてのシートのヘッダーは日本語で作成されます
- 英語版との対応表は `docs/header-mapping.md` を参照

### 2. サーバーライブラリのデプロイ

```bash
cd server-gas
npm install
npm run build  # TypeScriptをES5にコンパイル
clasp login  # 初回のみ
clasp push     # distフォルダの内容をGASにアップロード
```

GASエディタで：
1. [PDF_Watcher_ServerLib](https://script.google.com/home/projects/14oyw3dxeRB04LpXdn9fsU45V1QZ_rJsEwBZ-2PRNSsSIIMb-kyYbO0tM/edit)を開く
2. デプロイ → 新しいデプロイ
3. 種類：ライブラリ
4. 説明：PDF Watcher Server Library v1
5. デプロイ → **ライブラリIDをコピー**

### 3. クライアントGASのデプロイ

```bash
cd client-gas
npm install
npm run build  # TypeScriptをES5にコンパイル
clasp push     # distフォルダの内容をGASにアップロード
```

**注意:** サーバー側を更新した場合、クライアント側のGASエディタで「ライブラリ」→「更新」をクリックして最新版を取得する必要があります。

GASエディタで：
1. [Client Script](https://script.google.com/u/0/home/projects/18r9JpA-m18Uq5Z4UW58T8bCcjSmanGFtQHr7FyIQFgoUdkZftFeaEFLt/edit)を開く
2. ライブラリを追加（取得したライブラリID）
3. 識別子：PDFWatcherServerLib

### 4. Chrome拡張のインストール

#### 開発環境でのインストール

```bash
cd extension
npm install
npm run build  # esbuildで高速ビルド
```

1. chrome://extensions/ を開く
2. デベロッパーモードON
3. 「パッケージ化されていない拡張機能を読み込む」
4. `extension`フォルダを選択

#### 本番用パッケージの作成

```bash
cd extension
npm run build        # ビルド
npm run package      # extension.zipを作成
```

**ビルドシステムの特徴:**
- **esbuild**を使用した高速ビルド
- TypeScriptからJavaScriptへのトランスパイル
- 各エントリーポイント（background, content, popup）を個別にバンドル
- 本番用と開発用のmanifestファイルを分離
  - 開発用: `manifest.json`（scriptingパーミッション付き）
  - 本番用: `manifest-prod.json`（最小限のパーミッション）

## ✅ 動作確認

1. PDFを含むWebページでChrome拡張を使用
2. TSVをコピー
3. Client TemplateのCurrentシートに貼り付け
4. PDF Watcher → Run Judge
5. 各シートで結果を確認
   - **Changesシート**: 新規PDFのURL一覧（1行1URL）
   - **ChangesHistoryシート**: 過去5日間の変更履歴
   - **UserLogシート**: 実行履歴
   - **Summaryシート**: 直近3回の実行結果

## 🌟 今後のメンテナンス

### 定期的な保守作業
1. **スプレッドシートのデータ整理**
   - ArchivePDFシートの古いデータのアーカイブ
   - RunLog/UserLogの古いログの削除

2. **パフォーマンス監視**
   - 処理時間の監視
   - エラー率の確認

3. **Googleサービスの更新対応**
   - GAS APIの変更確認
   - Chrome拡張のManifest V3更新

## ⚠️ 注意事項

### 運用上の注意
- 大量ページ処理時は6分制限対策が自動的に動作
- エラー発生時に一部ページがスキップされる可能性あり（<1%）
- スプレッドシートのアクセス権限に注意

### 開発上の注意
- 設計書（pdfwatcher_design.md）を参照
- 要件定義書は変更しない
- GASのimport/export制限に注意

## 🐛 トラブルシューティング

### ライブラリが見つからない
- ライブラリIDが正しいか確認
- ライブラリがデプロイされているか確認

### スプレッドシートエラー
- IDが正しいか確認
- アクセス権限を確認

### Chrome拡張が動作しない
- manifest.jsonを確認
- コンソールでエラーを確認

### 6分制限エラー
- トリガーが正しく設定されているか確認
- ProcessingStateが正しく保存されているか確認
- 24時間以上経過した状態は無視される