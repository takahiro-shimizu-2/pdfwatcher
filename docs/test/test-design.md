# PDF Watcher テスト設計書

## 1. テスト概要

### 1.1 目的
PDF Watcherシステムの品質保証を目的とし、各コンポーネントの機能性、信頼性、パフォーマンスを検証する。

### 1.2 テスト対象
- **Core パッケージ**: 共通モデル、インターフェース、型定義
- **Server GAS**: サーバーライブラリ（リポジトリ、サービス、ロック機構）
- **Client GAS**: クライアントスクリプト（バッチ処理、UI更新）
- **Chrome Extension**: 拡張機能（PDF抽出、TSV生成）

### 1.3 テスト戦略
1. **単体テスト**: 各コンポーネントの独立した機能を検証
2. **統合テスト**: コンポーネント間の連携を検証
3. **システムテスト**: エンドツーエンドのシナリオを検証
4. **受入テスト**: ユーザー要件の充足を検証

### 1.4 テスト環境
- **開発環境**: Node.js 18+, TypeScript 5.x, Jest 29.x
- **GAS環境**: Google Apps Script (V8 runtime)
- **ブラウザ**: Chrome 120+
- **テストデータ**: モックPDFデータ、テスト用スプレッドシート

## 2. テストアーキテクチャ

### 2.1 テストフレームワーク構成
```
test/
├── unit/                    # 単体テスト
│   ├── core/               # Coreパッケージテスト
│   ├── server/             # Server GASテスト
│   ├── client/             # Client GASテスト
│   └── extension/          # Chrome拡張テスト
├── integration/            # 統合テスト
│   ├── server-client/      # Server-Client連携
│   └── extension-client/   # Extension-Client連携
├── system/                 # システムテスト
│   └── e2e/               # E2Eシナリオ
├── fixtures/              # テストデータ
├── mocks/                 # モックオブジェクト
└── utils/                 # テストユーティリティ
```

### 2.2 モック戦略
- **Google Apps Script API**: jest-mock-gas使用
- **スプレッドシート**: インメモリモック実装
- **Chrome API**: chrome-mock使用
- **外部HTTP**: MSW (Mock Service Worker)使用

### 2.3 テストデータ管理
- **PDFデータ**: 3パターン（小規模、中規模、大規模）
- **URL**: 有効URL、無効URL、タイムアウトURL
- **スプレッドシート**: 事前定義されたテストケース

## 3. 単体テスト設計

### 3.1 Core パッケージ

#### 3.1.1 モデルクラステスト
- **Page**: URL正規化、ハッシュ計算、等価性判定
- **PDF**: 状態遷移、バリデーション
- **DiffResult**: 差分計算ロジック
- **BatchResult**: 結果集計、エラー処理

#### 3.1.2 インターフェーステスト
- 各リポジトリインターフェースの契約検証
- 型安全性の確認

### 3.2 Server GAS

#### 3.2.1 リポジトリ層
- **SheetArchiveRepository**
  - getPdfsByPage: ページネーション、フィルタリング
  - upsertPdfs: 挿入/更新ロジック、重複処理
  - getAllPdfs: 大量データ処理
  
- **SheetHistoryRepository**
  - addPageHistory: タイムスタンプ、順序保証
  - getPageHistory: 期間フィルタ、ソート
  
- **SheetSummaryRepository**
  - updatePageSummary: 原子性、競合制御
  - getPageSummary: キャッシュ動作
  
- **SheetRunLogRepository**
  - addRunLog: ログローテーション
  - getRunLogs: クエリパフォーマンス

#### 3.2.2 サービス層
- **DiffService**
  - calculateDiff: 全パターンの差分計算
  - mergeDiffResults: 複数結果のマージロジック
  
- **SummaryService**
  - updateSummary: 統計計算の正確性
  - rotateSummary: 古いデータの削除

#### 3.2.3 インフラ層
- **DocumentLock**
  - acquire: タイムアウト処理
  - release: 例外時の解放保証
  - 競合シミュレーション

### 3.3 Client GAS

#### 3.3.1 バッチ処理
- **splitIntoBatches**: サイズ計算、境界値
- **executeBatchesInParallel**: 並列度制御、エラー伝播

#### 3.3.2 UI更新
- **updateChangesSheet**: フォーマット、ソート
- **updateUserLog**: ログローテーション
- **clearCurrentSheet**: 安全なクリア処理

#### 3.3.3 パーサー
- **parseCurrentSheet**: TSV解析、エラー処理
- バリデーションロジック

### 3.4 Chrome Extension

#### 3.4.1 コンテンツスクリプト
- **PDF抽出**: DOM解析パターン
- **ハッシュ計算**: 一貫性検証

#### 3.4.2 バックグラウンド
- **メッセージング**: 通信プロトコル
- **ストレージ**: 永続化ロジック

#### 3.4.3 ポップアップ
- **UI状態管理**: ユーザーインタラクション
- **クリップボード**: コピー機能

## 4. 統合テスト設計

### 4.1 Server-Client連携
- **バッチ実行フロー**: 正常系、異常系
- **ロック競合**: 複数クライアント同時実行
- **データ整合性**: トランザクション境界

### 4.2 Extension-Client連携
- **データフォーマット**: TSV生成と解析
- **大量データ**: パフォーマンス検証

## 5. システムテスト設計

### 5.1 E2Eシナリオ
1. **初回実行**: 空の状態からの実行
2. **PDF追加検出**: 新規PDF発見フロー
3. **PDF削除検出**: 削除されたPDFの処理
4. **大規模実行**: 1000+ PDFの処理
5. **エラーリカバリ**: 部分失敗からの復旧

### 5.2 パフォーマンステスト
- **レスポンスタイム**: 各操作の実行時間
- **スループット**: 単位時間あたりの処理数
- **リソース使用**: メモリ、CPU使用率

### 5.3 ストレステスト
- **同時実行**: 最大並列度の検証
- **データ量**: 限界データ量の特定
- **長時間実行**: メモリリーク検証

## 6. 受入テスト設計

### 6.1 ユーザーシナリオ
1. **研究者シナリオ**: 定期的なPDF監視
2. **管理者シナリオ**: 複数ページの一括処理
3. **初心者シナリオ**: 初期設定から実行まで

### 6.2 ユーザビリティテスト
- **Chrome拡張**: 操作の直感性
- **スプレッドシート**: データの可読性
- **エラーメッセージ**: 理解しやすさ

## 7. テスト実行計画

### 7.1 フェーズ分け
1. **Phase 1**: Core単体テスト（1週目）
2. **Phase 2**: Server/Client単体テスト（2週目）
3. **Phase 3**: 統合テスト（3週目）
4. **Phase 4**: システム/受入テスト（4週目）

### 7.2 優先順位
1. **Critical**: データ整合性、ロック機構
2. **High**: 基本機能、エラー処理
3. **Medium**: UI、パフォーマンス
4. **Low**: エッジケース、最適化

### 7.3 終了条件
- カバレッジ: 80%以上
- Critical/Highの欠陥: 0件
- パフォーマンス基準: 全て達成

## 8. リスクと対策

### 8.1 技術的リスク
- **GAS制限**: 実行時間、API制限
  - 対策: バッチサイズ最適化、リトライ実装
  
- **並行性問題**: デッドロック、レースコンディション
  - 対策: 徹底したロックテスト、タイムアウト設定

### 8.2 環境リスク
- **Google API変更**: 仕様変更による影響
  - 対策: APIバージョン固定、定期的な確認
- **アクセス権限エラー**: マスタースプレッドシートへのアクセス権限不足
  - 対策: 明確なエラーメッセージ表示（スプレッドシートID含む）、権限設定ガイド作成
  - 確認済み: 2025-06-21に権限エラー時の適切なエラー処理を確認

### 8.3 データリスク
- **大量データ**: スプレッドシート制限
  - 対策: アーカイブ機能、データ分割

## 9. テスト自動化

### 9.1 CI/CD統合
- **GitHub Actions**: プルリクエスト時の自動実行
- **カバレッジレポート**: Codecov連携
- **パフォーマンス監視**: 実行時間トラッキング

### 9.2 定期実行
- **日次**: 単体テスト、統合テスト
- **週次**: システムテスト
- **月次**: パフォーマンステスト、ストレステスト

## 10. メトリクスと報告

### 10.1 品質メトリクス
- **テストカバレッジ**: 行、分岐、関数
- **欠陥密度**: コンポーネント別
- **MTBF**: 平均故障間隔

### 10.2 進捗メトリクス
- **テスト実行率**: 計画vs実績
- **欠陥発見率**: フェーズ別
- **修正時間**: 優先度別

### 10.3 報告体制
- **日次**: 実行結果サマリ
- **週次**: 詳細分析レポート
- **完了時**: 最終品質報告書