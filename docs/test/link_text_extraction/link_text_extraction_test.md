# リンクテキスト抽出機能改善 テスト仕様書

## 関連ドキュメント
- 設計書: [link_text_extraction_design.md](../../link_text_extraction_design.md)
- 開発TODOリスト: [link_text_extraction_TODO.md](../../TODOリスト/link_text_extraction_TODO.md)
- テストTODOリスト: [link_text_extraction_test_TODO.md](./link_text_extraction_test_TODO.md)

## 1. テスト概要

### 1.1 テスト目的
リンクテキスト抽出機能の改善により、以下が正しく動作することを確認する：
- ネストされたHTML要素内のテキストが正しく抽出される
- 文字数制限が撤廃され、長いテキストも完全に取得される
- pdfsizeクラスを含むテキストも取得される
- 既存の機能に影響がないこと

### 1.2 テスト範囲
- 影響を受ける機能: PDFリンクのテキスト抽出処理
- 影響を受けない機能: TSVフォーマット、Google Sheets連携、その他の抽出処理

### 1.3 テスト環境
- Chrome ブラウザ（最新版）
- テスト用Webページ（ローカルHTML）
- Google Sheets（テスト用スプレッドシート）

## 2. テスト項目

### 2.1 単体テスト

#### 2.1.1 extractLinkSubject関数のテスト

**テスト仕様**
- 対象: `extension/src/utils/extractor.ts`のextractLinkSubject関数
- 目的: 様々なHTML構造からテキストが正しく抽出されることを確認

**テストケース**

| ID | テスト内容 | 入力HTML | 期待結果 | 優先度 |
|----|---------|----------|---------|--------|
| UT-01 | 単純なテキスト抽出 | `<a href="test.pdf">シンプルなテキスト</a>` | "シンプルなテキスト" | 高 |
| UT-02 | ネストされた要素のテキスト抽出 | `<a href="test.pdf"><strong>重要</strong>な<em>文書</em></a>` | "重要な文書" | 高 |
| UT-03 | span要素を含むテキスト | `<a href="test.pdf">通常<span>テキスト</span>混在</a>` | "通常テキスト混在" | 高 |
| UT-04 | pdfsizeクラスを含むテキスト | `<a href="test.pdf">ファイル名<span class="pdfsize">(PDF:1.2MB)</span></a>` | "ファイル名(PDF:1.2MB)" | 高 |
| UT-05 | 空のリンク | `<a href="test.pdf"></a>` | "test.pdf"（ファイル名） | 中 |
| UT-06 | 空白のみのリンク | `<a href="test.pdf">   </a>` | "test.pdf"（ファイル名） | 中 |
| UT-07 | 100文字以上のテキスト | `<a href="test.pdf">[101文字のテキスト]</a>` | [101文字の完全なテキスト] | 高 |
| UT-08 | タブ文字を含むテキスト | `<a href="test.pdf">タブ\tを含む</a>` | "タブ を含む" | 高 |
| UT-09 | 改行を含むテキスト | `<a href="test.pdf">改行\nを\r\n含む</a>` | "改行 を 含む" | 高 |
| UT-10 | 連続する空白 | `<a href="test.pdf">連続   する   空白</a>` | "連続 する 空白" | 中 |

### 2.2 統合テスト

#### 2.2.1 Chrome拡張機能での抽出テスト

**テスト仕様**
- 対象: Chrome拡張機能全体のPDF抽出機能
- 目的: 実際のWebページでPDFリンクが正しく抽出されることを確認

**テストケース**

| ID | テスト内容 | テストページ | 確認項目 | 優先度 |
|----|---------|------------|---------|--------|
| IT-01 | 複数のPDFリンク抽出 | edge_case_test.html | すべてのPDFリンクが抽出される | 高 |
| IT-02 | TSVフォーマット確認 | 任意のテストページ | 4列のTSV形式が維持される | 高 |
| IT-03 | 特殊文字のエスケープ | 特殊文字を含むページ | タブ・改行が正しくエスケープされる | 高 |
| IT-04 | 埋め込みPDFの抽出 | embed/object/iframeを含むページ | 埋め込みPDFも抽出される | 中 |

### 2.3 E2Eテスト

#### 2.3.1 Google Sheets連携テスト

**テスト仕様**
- 対象: Chrome拡張機能からGoogle Sheetsまでの全体フロー
- 目的: データが正しくGoogle Sheetsに反映されることを確認

**テストケース**

| ID | テスト内容 | 手順 | 期待結果 | 優先度 |
|----|---------|-----|---------|--------|
| E2E-01 | 基本的なデータ連携 | 1. PDFリンク抽出<br>2. TSVコピー<br>3. Currentシート貼り付け<br>4. runJudge実行 | 各シートに正しくデータが反映される | 高 |
| E2E-02 | 長いテキストの連携 | 100文字以上のリンクテキストを含むデータで同上の手順 | 長いテキストが切れずに保存される | 高 |
| E2E-03 | 特殊なHTML構造の連携 | ネストされたHTML要素を含むリンクで同上の手順 | 完全なテキストが保存される | 高 |

### 2.4 回帰テスト（無影響確認）

#### 2.4.1 既存機能の動作確認

**テスト仕様**
- 対象: 修正の影響を受けない既存機能
- 目的: 既存機能が引き続き正常に動作することを確認

**テストケース**

| ID | テスト内容 | 確認項目 | 期待結果 | 優先度 |
|----|---------|---------|---------|--------|
| RT-01 | PDFのURL抽出 | PDFのURLが正しく抽出される | 変更なし | 高 |
| RT-02 | ページURLとハッシュ | ページ情報が正しく取得される | 変更なし | 中 |
| RT-03 | 埋め込みPDF検出 | embed/object/iframeのPDFが検出される | 変更なし | 中 |
| RT-04 | TSV列構造 | 4列のTSV構造が維持される | 変更なし | 高 |
| RT-05 | エラーハンドリング | 不正なURLでエラーが発生しない | 変更なし | 中 |

### 2.5 パフォーマンステスト

**テスト仕様**
- 対象: 大量のPDFリンクを含むページでの処理性能
- 目的: パフォーマンスの劣化がないことを確認

**テストケース**

| ID | テスト内容 | 条件 | 期待結果 | 優先度 |
|----|---------|-----|---------|--------|
| PT-01 | 100個のPDFリンク処理 | パフォーマンステスト用ページ | 5秒以内に完了 | 中 |
| PT-02 | メモリ使用量 | 同上 | メモリリークなし | 中 |

## 3. テスト実施手順

### 3.1 単体テスト
1. テスト用HTMLファイルを作成
2. extractLinkSubject関数を個別にテスト
3. 各テストケースの結果を記録

### 3.2 統合テスト
1. Chrome拡張機能をビルド
2. テスト用Chromeプロファイルにインストール
3. テストページを開いて拡張機能を実行
4. 結果を確認

### 3.3 E2Eテスト
1. テスト用Google Sheetsを準備
2. Chrome拡張機能でデータを抽出
3. Google Sheetsに貼り付けて処理実行
4. 各シートのデータを確認

## 4. 合格基準

### 4.1 必須条件
- すべての高優先度テストケースが成功すること
- 既存機能に影響がないこと（回帰テストがすべて成功）
- エラーが発生しないこと

### 4.2 望ましい条件
- すべての中優先度テストケースが成功すること
- パフォーマンスの大幅な劣化がないこと

## 5. テストデータ

### 5.1 テスト用HTMLファイル
- `test_simple.html`: 基本的なPDFリンク
- `test_nested.html`: ネストされたHTML要素
- `test_special.html`: 特殊文字を含むリンク
- `test_performance.html`: 大量のPDFリンク

### 5.2 期待値データ
- 各テストケースの期待される出力をファイルに保存
- 自動比較用のスクリプトを準備

## 6. リスクと対策

### 6.1 リスク
- 長いテキストによるレイアウト崩れ
- 特殊文字によるTSVフォーマットの破壊
- パフォーマンスの劣化

### 6.2 対策
- UI表示のテストを重点的に実施
- エスケープ処理のテストを徹底
- パフォーマンス測定を実施