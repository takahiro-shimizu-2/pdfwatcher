# This List Fixed

# GAS 6分実行時間制限対策 テスト仕様書

## 1. テスト概要

### 1.1 テスト目的
GAS 6分実行時間制限対策機能が正しく動作することを確認し、以下を検証する：
- 大量ページの処理が分割して実行されること
- 6分制限に達する前に処理が適切に中断されること
- 中断後、自動的に処理が再開されること
- データの整合性が保たれること

### 1.2 処理単位の階層構造
処理は以下の3つの階層で管理される：
1. **全体処理**: すべてのページを処理
2. **グループ単位** (30ページ): 6分制限対策のための分割単位
   - トリガーによる再実行の単位
   - 5分以内に処理可能なサイズ
3. **ミニバッチ単位** (5ページ): 実際の処理単位
   - タイムアウト時の影響を最小化
   - 完了済みミニバッチは再処理されない
   - UserLogにはミニバッチごとに記録される

### 1.3 テスト範囲
- 処理分割機能（グループ分割、ミニバッチ分割）
- トリガー管理機能
- 状態管理機能（processedPagesカウント、completedMiniBatches記録）
- UI機能（Toast通知）
- エラー処理（DIContainer並行実行対策含む）

### 1.4 テスト環境
- Google Apps Script環境
- テスト用スプレッドシート
- テスト用PDFページデータ（test-utilities.gsで生成）
- マスタースプレッドシート（中央データ保管）

## 2. テストケース

### 2.1 基本機能テスト

#### TC-001: 小規模データ処理（30ページ以下）
**目的**: 1グループで完了する処理が正常に動作することを確認
**前提条件**: 
- Currentシートに20ページのデータを準備
**手順**:
1. runJudge()を実行
2. 処理完了まで待機
**期待結果**:
- 処理が1グループで完了する（内部的には複数のミニバッチに分割）
- トリガーが設定されない（または即座に削除される）
- 全20ページが正常に処理される

#### TC-002: 中規模データ処理（31-90ページ）
**目的**: 複数グループに分割される処理が正常に動作することを確認
**前提条件**:
- Currentシートに60ページのデータを準備
**手順**:
1. runJudge()を実行
2. 1回目の処理完了を待機
3. 自動的に2回目の処理が開始されることを確認
**期待結果**:
- 2グループに分けて処理される（30ページずつ）
  - グループ1: 30ページ（6ミニバッチ）
  - グループ2: 30ページ（6ミニバッチ）
- processedPagesが正しく累積される（30→60）
- トリガーが適切に設定・削除される
- 全60ページが正常に処理される

#### TC-003: 大規模データ処理（91ページ以上）
**目的**: 3回以上の分割処理が正常に動作することを確認
**前提条件**:
- Currentシートに120ページのデータを準備
**手順**:
1. runJudge()を実行
2. 各処理の完了と次回実行を確認
**期待結果**:
- 4グループに分けて処理される（30ページずつ）
  - 各グループは6ミニバッチ（各ミニバッチ5ページ）
- processedPagesの累積: 30 → 60 → 90 → 120
- 各回でトリガーが適切に管理される
- 全120ページが正常に処理される

### 2.2 時間制限テスト

#### TC-004: 5分経過時の自動中断
**目的**: 5分経過時に処理が適切に中断されることを確認
**前提条件**:
- 処理時間を意図的に遅延させる仕組みを準備
- 50ページのデータを準備
**手順**:
1. runJudge()を実行
2. 5分経過を待つ
**期待結果**:
- 5分経過時点で処理が中断される
- 処理状態が「paused」で保存される
- トリガーが残っている

#### TC-005: 6分制限シミュレーション
**目的**: 実際の6分制限に近い状況での動作を確認
**前提条件**:
- 実際の処理時間に近い環境を準備
- 40ページのデータを準備（6分ギリギリの量）
**手順**:
1. runJudge()を実行
2. 処理の進行を監視
**期待結果**:
- 30ページ処理後、適切に中断される
- 次回実行で残り10ページが処理される

### 2.3 状態管理テスト

#### TC-006: 処理状態の保存と復元
**目的**: 処理状態が正しく保存・復元されることを確認
**前提条件**:
- 60ページのデータを準備
**手順**:
1. runJudge()を実行
2. 1回目の処理後、PropertiesServiceの内容を確認
3. 2回目の処理開始時の状態を確認
**期待結果**:
- 処理状態が正しく保存されている
- currentGroupIndex、processedPagesが適切に更新される
- 2回目開始時に状態が正しく復元される

#### TC-007: 古い処理状態の無視
**目的**: 24時間以上経過した処理状態が無視されることを確認
**前提条件**:
- 古い処理状態をPropertiesServiceに設定
**手順**:
1. 25時間前のタイムスタンプを持つ状態を設定
2. runJudge()を実行
**期待結果**:
- 古い状態が無視される
- 新規処理として開始される

### 2.4 トリガー管理テスト

#### TC-008: トリガーの設定と削除
**目的**: トリガーが適切に管理されることを確認
**前提条件**:
- 60ページのデータを準備
**手順**:
1. 既存トリガーを確認
2. runJudge()を実行
3. トリガーの設定を確認
4. 処理完了後のトリガー削除を確認
**期待結果**:
- 処理開始時にトリガーが設定される
- 処理完了時にトリガーが削除される
- 重複トリガーが作成されない

#### TC-009: 異常終了時のトリガー残存
**目的**: エラー時にトリガーが残ることを確認
**前提条件**:
- エラーを発生させる仕組みを準備
**手順**:
1. エラーが発生する状況でrunJudge()を実行
2. エラー後のトリガー状態を確認
**期待結果**:
- エラー発生後もトリガーが残る
- 次回実行でリトライされる

### 2.5 UI機能テスト（実装見送り）

#### TC-010: 既存メニューの動作確認
**目的**: 既存の「判定を実行」メニューが正しく動作することを確認
**前提条件**:
- スプレッドシートを開く
**手順**:
1. スプレッドシートを開く
2. 「PDF Watcher」メニューを確認
3. 「判定を実行」を選択
**期待結果**:
- メニューが正しく表示される
- 6分制限対策モードで処理が開始される

#### TC-011: Toast通知の表示確認
**目的**: 処理状況がtoast通知で正しく表示されることを確認
**前提条件**:
- 処理実行中の状態
**手順**:
1. runJudge()を実行
2. 画面右下の通知を確認
**期待結果**:
- 処理開始時：「○○ページを○グループに分割して処理を開始します」
- 中断時：「グループ ○/○ まで完了。5分後に自動的に再開されます。」
- 再開時：「処理を再開します（グループ ○/○）」
- 完了時：「すべての処理が完了しました（総処理時間: ○○秒）」

#### ~~TC-012: 処理のキャンセル~~（実装見送り）
カスタムメニューを実装しないため、処理のキャンセル機能はテスト対象外

### 2.6 エラー処理テスト

#### TC-013: ネットワークエラー時の動作
**目的**: ネットワークエラー時の処理を確認
**前提条件**:
- ネットワークエラーをシミュレート
**手順**:
1. 処理中にネットワークエラーを発生させる
2. エラー後の動作を確認
**期待結果**:
- エラーが記録される
- 処理状態が保存される
- 次回実行でリトライされる

#### TC-014: 3回連続エラー時の停止
**目的**: 連続エラー時に処理が停止することを確認
**前提条件**:
- 連続してエラーが発生する状況を準備
**手順**:
1. エラーが発生する状況でrunJudge()を実行
2. 3回の自動リトライを確認
**期待結果**:
- 3回目のエラー後、処理が停止
- ステータスが「cancelled」になる
- エラーメッセージが保存される

### 2.7 境界値テスト

#### TC-015: 0ページの処理
**目的**: データがない場合の動作を確認
**前提条件**:
- Currentシートが空
**手順**:
1. runJudge()を実行
**期待結果**:
- エラーが発生しない
- 適切なメッセージが表示される

#### TC-016: 1ページの処理
**目的**: 最小データでの動作を確認
**前提条件**:
- Currentシートに1ページのデータ
**手順**:
1. runJudge()を実行
**期待結果**:
- 正常に処理される
- トリガーが設定されない

#### TC-017: ちょうど30ページの処理
**目的**: グループ境界での動作を確認
**前提条件**:
- Currentシートに30ページのデータ
**手順**:
1. runJudge()を実行
**期待結果**:
- 1回で処理が完了
- トリガーが適切に管理される

### 2.8 同時実行テスト

#### TC-018: 同時実行の防止
**目的**: 複数の処理が同時に実行されないことを確認
**前提条件**:
- 2つのブラウザタブを準備
**手順**:
1. タブ1でrunJudge()を実行
2. すぐにタブ2でrunJudge()を実行
**期待結果**:
- 2つ目の実行がブロックされる
- 適切なメッセージが表示される

## 3. パフォーマンステスト

### PT-001: 処理時間の測定
**目的**: 各グループサイズでの処理時間を測定
**測定項目**:
- 10ページの処理時間
- 30ページの処理時間
- 50ページの処理時間（比較用）
**合格基準**:
- 30ページが5分以内に処理される

### PT-002: メモリ使用量の確認
**目的**: 大量データ処理時のメモリ使用を確認
**測定項目**:
- 処理前後のメモリ使用量
- ピーク時のメモリ使用量
**合格基準**:
- メモリリークがない
- GASの制限内で動作

## 4. 回帰テスト

### RT-001: 既存機能への影響確認
**目的**: 6分制限対策が既存機能に影響しないことを確認
**確認項目**:
- 通常のrunJudge()実行
- バッチ処理の動作
- シート更新の正確性
- エラーハンドリング

## 5. テストデータ

### 5.1 基本テストデータ
- 小規模: 1-30ページ（1グループで完了）
- 中規模: 31-90ページ（2-3グループに分割）
- 大規模: 91ページ以上（4グループ以上に分割）
- 超大規模: 1000ページ（34グループに分割）

### 5.2 特殊テストデータ
- 空データ
- 不正なURL
- 重複URL
- 特殊文字を含むURL

## 6. テスト実施手順

### 6.1 準備
1. テスト用スプレッドシートの作成
2. テストデータの準備
3. 開発版スクリプトのデプロイ

### 6.2 実施
1. 各テストケースを順次実行
2. 結果を記録
3. 不具合があれば報告

### 6.3 完了条件
- 全テストケースが合格
- パフォーマンス基準を満たす
- 既存機能への影響がない

## 7. リスクと対策

### 7.1 リスク
- 6分制限の正確なシミュレーションが困難
- PropertiesServiceの容量制限
- トリガーの設定制限
- DIContainerの並行実行問題（修正済み）
- processedPagesカウントの重複問題（修正済み）

### 7.2 対策
- 段階的なテスト実施
- 本番環境でのパイロットテスト
- ロールバック計画の準備