# TC-005: 6分制限との統合テスト 実施手順

## テスト概要
6分制限で処理が中断された場合、ChangesHistoryへの転写が行われず、最終的な処理完了時にのみ転写されることを確認する。

## テスト目的
1. 中断時（6分制限やユーザーによる手動停止）にChangesHistoryへの転写が行われないこと
2. 継続実行中も転写が行われないこと
3. 最終完了時（currentGroup >= totalGroups）に全データが転写されること

## 推奨テスト方法

### 方法1: 手動中断による検証（推奨）

1. **テストデータの準備**
   ```javascript
   test_CHT005C_realInterruption()
   ```
   - 8ページ、各15個のPDF（計120個）のテストデータを生成

2. **処理開始と中断**
   - `runJudge()`を実行
   - UserLogシートで処理が開始されたことを確認
   - 約30秒後（1-2グループ処理後）に手動で実行を停止
     - スクリプトエディタの「実行を停止」ボタンをクリック

3. **中断状態の確認**
   ```javascript
   checkCHT005Status()
   ```
   - 処理状態が`paused`であることを確認
   - ChangesHistory件数が0件であることを確認（重要）

4. **継続実行**
   ```javascript
   runJudgeContinuation()
   ```
   - 処理が再開されることを確認
   - 処理完了まで待機

5. **結果確認**
   ```javascript
   checkCHT005Result()
   ```
   - ChangesHistoryにデータが転写されたことを確認
   - Changesシートの件数とChangesHistoryの件数が一致することを確認

### 方法2: 疑似的な中断状態のシミュレート

より簡易的にテストしたい場合：

1. **テスト準備**
   ```javascript
   test_CHT005B_simulatedTimeout()
   ```
   - 処理状態を手動で「中断済み」に設定
   - Changesシートに仮のデータを追加

2. **状態確認と継続実行**
   - 以降は方法1の手順3以降と同じ

## 期待される結果

### ✅ 合格条件
1. **中断時の動作**
   - 処理が中断された時点でChangesHistoryは空（0件）
   - 処理状態が`paused`として保存されている

2. **継続実行時の動作**
   - `runJudgeContinuation()`で処理が再開される
   - 継続実行中もChangesHistoryへの転写は行われない

3. **完了時の動作**
   - すべてのグループ処理完了時に初めてChangesHistoryへ転写される
   - Changesシートのすべてのデータが転写される

### ❌ 不合格となる場合
- 中断時にChangesHistoryにデータが存在する
- 継続実行中に転写が行われる
- 最終的にデータ数が一致しない

## 補足情報

### 処理状態の確認方法
```javascript
quickTestCHT005()  // 現在の状態を素早く確認
```

### トラブルシューティング
1. **処理が自動的に継続されてしまう場合**
   - トリガーが設定されている可能性があるため、トリガー管理画面で確認・削除

2. **ChangesHistoryに予期しないデータがある場合**
   - `clearTestData()`を実行してからテストをやり直す

3. **継続実行ができない場合**
   - 処理状態が正しく保存されているか確認
   - Script PropertiesのPDF_WATCHER_STATEを確認

## 注意事項
- 実際の6分制限は開発環境では再現が困難なため、手動での中断でシミュレート
- テスト実施前に必ず`clearTestData()`でデータをクリアすること
- 処理中断のタイミングは1-2グループ処理後が理想的（完全に処理開始前では意味がない）