# Changes履歴保存機能 テスト仕様書

## 概要
Changes履歴保存機能のテスト仕様とテストケースを定義する。

## 関連ドキュメント
- 設計書: [changes-history_design.md](../../TODOリスト/changes-history_design.md)
- 実装TODOリスト: [changes-history_TODO.md](../../TODOリスト/changes-history_TODO.md)
- テストTODOリスト: [changes-history_test_TODO.md](./changes-history_test_TODO.md)

## テスト方針

### テスト観点
1. **機能テスト**: 正常系・異常系の動作確認
2. **性能テスト**: パフォーマンスへの影響確認
3. **統合テスト**: 既存機能との連携確認
4. **回帰テスト**: 既存機能への影響確認

### 影響範囲
- **直接影響**: runJudge関数、Changesシート、新規ChangesHistoryシート
- **間接影響**: UserLogシート（処理時間記録）、6分制限処理
- **無影響確認**: バッチ処理、差分検出、サーバー側処理

## テスト仕様

### TS-001: 履歴転写機能

#### 目的
Changesシートのデータが正しくChangesHistoryシートに転写されることを確認する。

#### 前提条件
- Changesシートにテストデータが存在する
- ChangesHistoryシートは存在しない（自動作成テスト）

#### テスト項目
1. **正常系**
   - 単一データの転写
   - 複数データの転写（100件）
   - 空のChangesシートからの転写
   - 日本語URLを含むデータの転写

2. **異常系**
   - ChangesHistoryシートの作成権限がない場合
   - Changesシートが存在しない場合

### TS-002: 期限切れデータ削除機能

#### 目的
5日経過したデータが正しく削除されることを確認する。

#### 前提条件
- ChangesHistoryシートに様々な日付のテストデータが存在

#### テスト項目
1. **正常系**
   - 5日経過データの削除
   - 4日23時間59分のデータは削除されない
   - 複数の期限切れデータの一括削除
   - 期限内データと期限切れデータの混在

2. **異常系**
   - ChangesHistoryシートが存在しない場合
   - データ形式が不正な場合

### TS-003: runJudgeとの統合

#### 目的
runJudge関数に統合された履歴機能が既存機能に影響を与えないことを確認する。

#### 前提条件
- 本番相当のテストデータ

#### テスト項目
1. **正常系**
   - 初回実行（Changesが空）
   - 2回目実行（前回データの転写）
   - 6分制限での中断・再開

2. **エラー耐性**
   - 転写エラー時もrunJudgeは継続
   - 削除エラー時もrunJudgeは継続

### TS-004: パフォーマンステスト

#### 目的
履歴機能追加によるパフォーマンス影響が許容範囲内であることを確認する。

#### 測定項目
- 転写処理時間（目標: 0.5秒以内）
- 削除処理時間（目標: 0.3秒以内）
- runJudge全体への影響（目標: 1秒以内）

#### テストデータ
- Changes: 0件、50件、200件
- ChangesHistory: 0件、500件、1000件

### TS-005: データ整合性テスト

#### 目的
データの整合性が保たれることを確認する。

#### テスト項目
1. **フィールド整合性**
   - SavedAtが正しいUTC時刻
   - ExpiresAtがSavedAt + 5日
   - RunIdの一意性

2. **重複防止**
   - 同一実行での重複なし
   - 異なる実行での同一URLは別レコード

## テストケース詳細

### TC-001: 基本的な転写機能
```
1. Changesシートに以下のデータを設定:
   - https://example.com/doc1.pdf
   - https://example.com/doc2.pdf

2. runJudgeを実行

3. 確認項目:
   - ChangesHistoryシートが作成される
   - 2件のデータが転写される
   - SavedAtが現在時刻（±1分）
   - ExpiresAtがSavedAt + 5日
   - Changesシートがクリアされる
```

### TC-002: 大量データ転写
```
1. Changesシートに200件のPDF URLを設定

2. runJudgeを実行

3. 確認項目:
   - 200件すべてが転写される
   - 処理時間が0.5秒以内
   - メモリエラーが発生しない
```

### TC-003: 期限切れデータ削除
```
1. ChangesHistoryに以下を設定:
   - 6日前のデータ: 10件
   - 5日前のデータ: 5件
   - 4日前のデータ: 5件

2. runJudgeを実行

3. 確認項目:
   - 6日前と5日前の15件が削除
   - 4日前の5件は残存
   - 削除処理時間が0.3秒以内
```

### TC-004: エラー時の継続性
```
1. ChangesHistoryシートを読み取り専用に設定

2. Changesシートにデータを設定してrunJudge実行

3. 確認項目:
   - エラーログが出力される
   - runJudgeの処理は継続される
   - バッチ処理が正常に実行される
```

### TC-005: 6分制限との統合
```
1. 大量データで6分制限が発動する状態を作成

2. runJudgeを実行（中断される）

3. 継続実行

4. 確認項目:
   - 初回実行時に転写が実行される
   - 継続実行時には転写されない
   - 最終的にすべての処理が完了
```

### TC-006: 既存機能への無影響確認
```
1. 履歴機能を有効にした状態で以下を確認:
   - バッチ処理の速度
   - 差分検出の精度
   - サーバー側処理への影響なし
   - UserLogの記録

2. 履歴機能の有無でパフォーマンス比較
```

## 合格基準

1. **機能要件**
   - すべての正常系テストケースがパス
   - エラー時も本処理が継続される

2. **非機能要件**
   - パフォーマンス影響が1秒以内
   - メモリ使用量の大幅な増加なし
   - エラーログが適切に出力される

3. **回帰テスト**
   - 既存のすべてのテストケースがパス
   - 既存機能の動作に変更なし

## テスト環境

- Google Apps Script実行環境
- テスト用スプレッドシート（本番データのコピー）
- Chrome拡張機能（既存のもの）

## リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| 大量データでのメモリ不足 | 処理中断 | バッチサイズの調整 |
| 削除処理の遅延 | パフォーマンス低下 | インデックスの活用 |
| シート作成権限なし | 機能不全 | エラーハンドリング強化 |