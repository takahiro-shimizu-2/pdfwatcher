# Changes履歴保存機能 テスト仕様書

## 概要
Changes履歴保存機能のテスト仕様とテストケースを定義する。

## 関連ドキュメント
- 設計書: [changes-history_design.md](../../TODOリスト/changes-history_design.md)
- 実装TODOリスト: [changes-history_TODO.md](../../TODOリスト/changes-history_TODO.md)
- テストTODOリスト: [changes-history_test_TODO.md](./changes-history_test_TODO.md)

## テスト方針

### 影響範囲分析

#### 直接影響（テスト必須）
1. **新規追加機能**
   - `executeHistoryManagement()`: 履歴管理のメイン処理
   - `transferChangesToHistory()`: Changesデータの転写
   - `deleteExpiredHistory()`: 期限切れデータ削除
   - ChangesHistoryシート: 新規作成されるシート

2. **既存機能への変更**
   - `completeProcessing()`: 履歴管理呼び出しを追加
   - `setupSpreadsheet()`: ChangesHistoryシート作成を追加

#### 間接影響（テスト推奨）
- 処理完了時の全体処理時間
- 6分制限での中断時の挙動（転写されないことの確認）

#### 無影響（テスト不要）
以下の機能は今回の修正で一切変更していないため、テスト不要：
- **バッチ処理ロジック**: `processGroups()`の内部処理は変更なし
- **差分検出処理**: `detectChanges()`は変更なし
- **サーバー側API**: サーバー側のコードは一切変更なし
- **Chrome拡張機能**: 拡張機能側のコードは変更なし
- **継続実行ロジック**: `runJudgeContinuation()`は変更なし
- **トリガー管理**: トリガー設定・削除処理は変更なし
- **UserLog記録**: ログ記録処理は変更なし

### テスト方針
1. **新規機能のテスト**: 履歴管理機能が正しく動作すること
2. **統合テスト**: 処理完了時に履歴管理が呼び出されること
3. **性能テスト**: 処理時間への影響が許容範囲内であること

## テスト仕様

### TS-001: 履歴転写機能

#### 目的
Changesシートのデータが正しくChangesHistoryシートに転写されることを確認する。

#### 前提条件
- Changesシートにテストデータが存在する
- ChangesHistoryシートは初期設定で作成済み

#### テスト結果（実施済み）
- ✅ 初期設定でChangesHistoryシートが作成される
- ✅ ヘッダーが正しい順番： [保存日時, 実行ID, ページURL, PDFのURL, 削除予定日時]
- ✅ 2回目の実行で前回のChangesデータ（14件）が転写される
- ✅ データが正しい順番で保存される

#### テスト項目
1. **正常系**
   - 単一データの転写
   - 複数データの転写（100件）
   - 空のChangesシートからの転写
   - 日本語URLを含むデータの転写

2. **異常系**
   - ChangesHistoryシートが存在しない場合（初期設定未実施）
   - Changesシートが存在しない場合

### TS-002: 期限切れデータ削除機能

#### 目的
5日経過したデータが正しく削除されることを確認する。

#### 前提条件
- ChangesHistoryシートに様々な日付のテストデータが存在

#### テスト項目
1. **正常系**
   - 5日経過データの削除
   - 4日23時間59分のデータは削除されない
   - 複数の期限切れデータの一括削除
   - 期限内データと期限切れデータの混在

2. **異常系**
   - ChangesHistoryシートが存在しない場合
   - データ形式が不正な場合

### TS-003: completeProcessing完了時の統合

#### 目的
completeProcessing関数で履歴管理機能が正しく動作し、既存機能に影響を与えないことを確認する。

#### 前提条件
- 本番相当のテストデータ

#### テスト項目
1. **正常系**
   - 初回実行完了時の転写
   - 複数グループ処理完了時の転写
   - 6分制限での中断時は転写されない
   - 継続実行完了時の転写

2. **エラー耐性**
   - 転写エラー時も処理完了は正常終了
   - 削除エラー時も処理完了は正常終了

### TS-004: パフォーマンステスト

#### 目的
履歴機能追加によるパフォーマンス影響が許容範囲内であることを確認する。

#### 測定項目
- 転写処理時間（目標: 0.5秒以内）
- 削除処理時間（目標: 0.3秒以内）
- runJudge全体への影響（目標: 1秒以内）

#### テストデータ
- Changes: 0件、50件、200件
- ChangesHistory: 0件、500件、1000件

### TS-005: データ整合性テスト

#### 目的
データの整合性が保たれることを確認する。

#### テスト項目
1. **フィールド整合性**
   - SavedAtが正しいUTC時刻
   - ExpiresAtがSavedAt + 5日
   - RunIdの一意性

2. **重複防止**
   - 同一実行での重複なし
   - 異なる実行での同一URLは別レコード

## テストケース詳細

### TC-001: 基本的な転写機能 ✅ 実施済み
```
テスト結果:
1. 初回実行: 14個のPDFを新規検出
   - Changesシートに14件のデータが記録
   - ChangesHistoryはまだ空（初回のため）

2. 2回目実行: 1個のPDFを新規検出
   - 前回の14件がChangesHistoryに転写された
   - 今回の1件もChangesHistoryに転写された

3. 確認された内容:
   - ✅ 保存日時: 2025/06/26 16:54:10（実行時刻）
   - ✅ 実行ID: UUID形式で正しく保存
   - ✅ ページURL: https://example.com/page1 等
   - ✅ PDFのURL: https://example.com/page1/document-001.pdf 等
   - ✅ 削除予定日時: 2025/07/01（保存日時+5日）
```

### TC-002: 大量データ転写
```
1. 処理中のChangesシートに200件のPDF URLが蓄積された状態

2. 最後のグループ処理が完了（currentGroup >= totalGroups）

3. 確認項目:
   - 完了判定時に200件すべてが転写される
   - 転写処理時間が0.5秒以内
   - メモリエラーが発生しない
   - トリガー削除前に転写が完了している
```

### TC-003: 期限切れデータ削除 ✅ 実施済み
```
テスト結果:
1. test_CHT003_setupExpiredData()でテストデータ作成:
   - 6日前のデータ: test_old_001
   - 5日と1時間前のデータ: test_old_002
   - 4日前のデータ: test_recent_001
   - 3日前のデータ: test_recent_002

2. runJudge()実行結果:
   - ✅ 削除対象データ2件が正しく削除
   - ✅ 保持対象データ2件が適切に保持
   - ✅ 削除処理時間: 483ms
   - ✅ 実行ログ: "期限切れ履歴を削除しました: 2件 (483ms)"
```

### TC-004: エラー時の継続性
```
1. ChangesHistoryシートを削除して初期設定未実施状態を作る

2. runJudgeを実行し、処理完了

3. 確認項目:
   - 転写エラーのログが出力される
   - 処理完了は正常に実行される
   - トリガー削除が正常に実行される
   - ステータスがクリアされる
```

### TC-005: 6分制限との統合 ✅ 実施済み（2025/06/26）
```
テストデータ: 200ページ × 50個のPDF = 10,000個

実測結果:
1. 5分制限での自動中断
   - ✅ 250.3秒で6/7グループ完了時点で自動中断
   - ✅ 処理状態が`paused`に移行
   - ✅ ChangesHistoryは0件（中断時は転写されない）

2. 自動継続実行（7分後）
   - ✅ トリガーで自動的に再開
   - ✅ 残りの1グループを処理

3. 完了時の転写処理
   - ✅ 9,891件のデータを4,278msで転写
   - ✅ ChangesシートとChangesHistoryが完全一致

詳細: TC-005-test-result-detail.md参照
```

### TC-006: 既存機能への無影響確認 ❌ テスト不要
```
理由: 以下の機能は今回の修正で一切変更していないためテスト不要
- バッチ処理: processGroups()の内部ロジックは変更なし
- 差分検出: detectChanges()は変更なし
- サーバー側処理: サーバー側コードは変更なし
- UserLog記録: ログ記録処理は変更なし
```

## 合格基準

1. **機能要件**
   - 新規追加した履歴機能が正しく動作する
   - エラー時も本処理が継続される

2. **非機能要件**
   - パフォーマンス影響が1秒以内
   - メモリ使用量の大幅な増加なし
   - エラーログが適切に出力される

3. **統合テスト**
   - 処理完了時に履歴機能が正しく呼び出される
   - 6分制限時には転写されない

## テスト環境

- Google Apps Script実行環境
- テスト用スプレッドシート（本番データのコピー）
- Chrome拡張機能（既存のもの）
- テストユーティリティ（test-utilities.gs）

## リスクと対策

| リスク | 影響 | 対策 | ステータス |
|--------|------|------|----------|
| 大量データでのメモリ不足 | 処理中断 | バッチサイズの調整 | 未検証 |
| 削除処理の遅延 | パフォーマンス低下 | 下から上への削除処理 | ✅ 実装済み |
| シート未作成 | 機能不全 | 初期設定で作成 | ✅ 実装・検証済み |