# Changes履歴保存機能 テスト実行ガイド

## 概要
このドキュメントは、Changes履歴保存機能のテスト実行手順を説明します。実際の運用フローに沿ってテストを実施します。

## 前提条件
1. Chrome拡張機能（PDF Watcher）がインストール済み
2. クライアントスプレッドシートへのアクセス権限
3. GASのコードがデプロイ済み（c-13-history-manager.js含む）

## テスト実行手順

### 1. 実運用フローでの統合テスト

#### 1.1 初期設定の確認
1. **スプレッドシートを開く**
   - クライアント用のGoogleスプレッドシートを開く

2. **初期設定を実行**
   - メニューから「PDF Watcher」→「初期設定」を選択
   - 以下のシートが作成されることを確認：
     - Current（データ入力用）
     - Changes（新規PDF一覧）
     - UserLog（実行履歴）
     - Summary（サマリー）
     - PageSummary（ページサマリー）

#### 1.2 テストデータの準備（実際の運用と同じ手順）

**方法A: Chrome拡張機能を使用（推奨）**
1. PDFが含まれるWebページを開く
2. Chrome拡張機能のアイコンをクリック
3. 「Extract & Copy」ボタンをクリック
4. Currentシートに貼り付け

**方法B: サンプルデータを使用**
1. Currentシートに以下のサンプルデータを貼り付け：
```
https://example.com/page1	abc123def456	https://example.com/doc1.pdf	https://example.com/doc2.pdf	https://example.com/doc3.pdf
https://example.com/page2	xyz789ghi012	https://example.com/doc4.pdf	https://example.com/doc5.pdf
https://example.com/page3	mno345pqr678	https://example.com/doc6.pdf	https://example.com/doc7.pdf	https://example.com/doc8.pdf
```

#### 1.3 初回実行（履歴なしの状態）
1. **メニューから「PDF Watcher」→「Run Judge」を実行**
2. **処理完了を待つ**（3ページなら数秒）
3. **以下を確認：**
   
   **✅ Changesシートの確認**
   - 新規PDFのURL一覧が表示される
   - 1行1URLの形式
   
   **✅ UserLogシートの確認**
   - 実行記録が追加される
   - 処理時間、ページ数、追加PDF数が記録される
   
   **❌ ChangesHistoryシートは作成されない**
   - 初回実行時はChangesにデータがないため転写されない

#### 1.4 2回目の実行（履歴転写のテスト）

1. **Currentシートに新しいデータを設定**
```
https://example.com/page1	abc123def456	https://example.com/doc1.pdf	https://example.com/doc2.pdf	https://example.com/doc9.pdf
https://example.com/page4	tuv901wxy234	https://example.com/doc10.pdf	https://example.com/doc11.pdf
```

2. **再度「Run Judge」を実行**

3. **処理完了後、以下を確認：**

   **✅ ChangesHistoryシートの確認**
   - シートが自動作成される
   - ヘッダー: 保存日時、実行ID、PDFのURL、ページURL、削除予定日時
   - 前回のChangesデータが転写されている
   
   **✅ 転写データの検証**
   - 保存日時: 現在時刻（±1分以内）
   - 実行ID: exec_で始まる一意のID
   - PDFのURL: 前回Changesに表示されていたURL
   - ページURL: PDFが存在するページのURL
   - 削除予定日時: 保存日時 + 5日

   **✅ 新しいChangesデータ**
   - 今回新規に検出されたPDFが表示される
   - 前回のデータは転写済みなので含まれない

### 2. パフォーマンステスト

#### 2.1 処理時間の測定
1. **UserLogシートで処理時間を確認**
   - 履歴機能追加前の処理時間と比較
   - 目標: 追加処理による遅延は1秒以内

2. **大量データでのテスト**
   - 50ページ、各50PDF（計2,500PDF）のデータで実行
   - 処理完了まで待つ（6分制限に注意）
   - 履歴転写・削除の処理時間を確認

### 3. 期限切れデータ削除のテスト

#### 3.1 削除機能の動作確認
1. **ChangesHistoryシートに古いデータを手動追加**
   - A列（保存日時）: `=NOW()-6` （6日前）
   - B列（実行ID）: `test_old_data`
   - C列（PDFのURL）: `https://example.com/old.pdf`
   - D列（ページURL）: `https://example.com/oldpage`
   - E列（削除予定日時）: `=NOW()-1` （1日前）

2. **runJudgeを実行**
   - 処理完了後、古いデータが削除されることを確認
   - 実行ログで削除件数を確認

### 4. エラー耐性のテスト

#### 4.1 ChangesHistoryシートが保護されている場合
1. **ChangesHistoryシートを保護**
   - シートを右クリック → 「シートを保護」
   - 編集権限を制限

2. **runJudgeを実行**
   - エラーが発生してもrunJudgeは正常に完了することを確認
   - 実行ログにエラーメッセージが記録されることを確認

3. **保護を解除**

### 5. 6分制限での動作確認

#### 5.1 大量データでの継続実行テスト
1. **200ページ以上のデータをCurrentシートに設定**
2. **runJudgeを実行**
3. **6分で中断された場合：**
   - 継続実行が自動でスケジュールされる
   - 最終的な完了時のみ履歴転写が実行される
   - 中断時には転写されないことを確認

## 確認観点のチェックリスト

### ✅ 基本機能
- [ ] ChangesHistoryシートが自動作成される
- [ ] 日本語ヘッダーが正しく表示される
- [ ] 転写データの各フィールドが正しい
- [ ] 削除予定日時が保存日時+5日になっている
- [ ] 実行IDが一意である

### ✅ データ整合性
- [ ] 前回のChangesデータがすべて転写される
- [ ] 転写後もChangesシートのデータは保持される
- [ ] 重複データが発生しない
- [ ] URLに日本語や特殊文字が含まれても正しく処理される

### ✅ パフォーマンス
- [ ] 転写処理: 0.5秒以内（目標）
- [ ] 削除処理: 0.3秒以内（目標）
- [ ] runJudge全体への影響: 1秒以内

### ✅ エラー処理
- [ ] 履歴管理でエラーが発生してもrunJudgeは継続する
- [ ] エラーメッセージが実行ログに記録される
- [ ] シート作成権限がなくてもクラッシュしない

### ✅ 運用面
- [ ] 5日経過したデータが自動削除される
- [ ] 6分制限での中断時は転写されない
- [ ] 最終完了時にのみ転写される

## トラブルシューティング

### よくある問題と対処法

1. **ChangesHistoryシートが作成されない**
   - 初回実行時はChangesが空なので正常
   - 2回目以降で作成されない場合は権限を確認

2. **データが転写されない**
   - runJudgeが最後まで完了しているか確認
   - 実行ログで「=== Changes履歴管理を開始 ===」を確認
   - execIdが正しく取得されているか確認

3. **削除されない**
   - 削除予定日時が本当に過去になっているか確認
   - 日付の形式が正しいか確認（Date型である必要）

4. **パフォーマンスが悪い**
   - ChangesHistoryシートのデータ量を確認
   - 不要な古いデータを手動削除
   - 5日間の保存期間を短縮することを検討