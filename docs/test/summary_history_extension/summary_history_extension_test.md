# PageSummary履歴管理拡張 テスト仕様書

## 概要
PageSummaryの履歴管理を3世代から7世代へ拡張する機能のテスト仕様書です。

## テスト実施結果

**実施日**: 2025年6月28日  
**実施環境**: 本番環境  
**実施者**: shimizu  
**結果**: ✅ 全テスト合格

### テスト実施サマリー
- **実行回数**: 8回（実行1〜実行8）
- **処理時間**: 18:01〜19:28（約1時間30分）
- **確認項目**: 
  - ✅ 7世代の履歴管理
  - ✅ 世代シフト機能
  - ✅ 最古データの自動削除（8回目）
  - ✅ 既存機能への影響なし
  - ✅ パフォーマンス基準クリア（最大9.924秒）

**関連ドキュメント:**
- 設計書: `../../summary_history_extension_design.md`
- TODO: `../../TODOリスト/summary_history_extension_TODO.md`
- テストTODO: `summary_history_extension_test_TODO.md`

## テスト概要

### テスト目的
1. 7世代の履歴が正しく保存・管理されることを確認
2. 既存の3世代データが正しく移行されることを確認
3. 8回目の実行で最古のデータが自動削除されることを確認
4. 既存機能への影響がないことを確認
5. パフォーマンスの大幅な低下がないことを確認

### テスト範囲
- **影響を受ける機能**
  - PageSummaryの更新処理
  - PageSummaryの取得処理
  - データ移行処理
  - Summaryシートの表示

- **影響を受けない機能（無影響確認）**
  - PageHistory（全履歴）の記録
  - ChangesHistory（5日間履歴）の管理
  - RunLogの記録
  - PDF検出・ダウンロード機能
  - その他の既存機能

## 実装テストガイド

### テストコード
`/docs/test/summary_history_extension/test-script.gs` をクライアントブックのGASエディタにコピーしてください。

### テスト実施手順

#### 準備
1. クライアントブックでGASエディタを開く
2. `test-script.gs`の内容をコピー
3. （オプション）`addTestMenu()`を実行して「7世代テスト」メニューを追加

#### 実装テスト

##### TEST-001: 初回実行
```javascript
test7Gen001_FirstRun()  // テストデータ投入
```
→ メニュー「PDF Watcher」→「判定を実行」
→ `checkPageSummaryGenerations()`で確認

**確認ポイント:** 実行1にデータが入る

##### TEST-002: 世代シフト
```javascript
test7Gen002_SecondRun()  // 新データ投入
```
→ メニュー「PDF Watcher」→「判定を実行」
→ `checkPageSummaryGenerations()`で確認

**確認ポイント:** 実行1に新データ、実行2に前回データ

##### TEST-003: 7世代フル活用
7回連続で以下を実行：
1. `generateTestDataForCurrent()`
2. メニュー「PDF Watcher」→「判定を実行」
3. 完了を待つ

**確認ポイント:** 実行1〜7すべてにデータ

##### TEST-004: 最古データ削除（8回目）
```javascript
test7Gen004_OldestDataDeletion()
```
→ メニュー「PDF Watcher」→「判定を実行」
→ `checkPageSummaryGenerations()`で確認

**確認ポイント:** 実行7に2回目データ、1回目データは削除

##### TEST-005: パフォーマンステスト
```javascript
test7Gen005_LargeDataPerformance()  // 1000個のPDF
```
→ メニュー「PDF Watcher」→「判定を実行」
→ UserLogで実行時間確認

**確認ポイント:** 6分以内に完了

### チェックリスト
- [ ] PageSummaryが30列構造
- [ ] ヘッダーが「実行1」〜「実行7」
- [ ] 新データが実行1に入る
- [ ] 既存データが右にシフト
- [ ] 8回目で最古データ削除
- [ ] 大規模データでも6分以内

### トラブルシューティング

#### エラー対処
- **Currentシートが見つからない** → クライアントブックで実行
- **PageSummaryが更新されない** → マスターブックの7世代対応を確認
- **IMPORTRANGEエラー** → アクセス権限とA:AD範囲を確認

#### 確認用関数
- `checkPageSummaryGenerations()` - 世代状態確認
- `checkPageSummaryStructure()` - シート構造確認
- `clearTestData()` - テストデータクリア

## テスト仕様詳細

### 1. 単体テスト

#### UT-001: PageSummaryモデルのテスト
**目的**: 新しいデータ構造が正しく定義されていることを確認
**前提条件**: TypeScriptのコンパイルが成功すること
**テスト項目**:
- `run4`, `run5`, `run6`, `run7`プロパティが追加されていること
- すべてのrunプロパティが`RunSummary`型であること
- 7世代分のデータを格納できること

#### UT-002: データ変換関数のテスト
**目的**: 3世代形式から7世代形式への変換が正しく行われることを確認
**テストケース**:
1. 完全な3世代データの変換
2. 一部欠損した3世代データの変換
3. 空のデータの変換
4. 不正な形式のデータのエラーハンドリング

#### UT-003: 世代シフト関数のテスト
**目的**: 世代のシフト処理が正しく行われることを確認
**テストケース**:
1. run1からrun6までデータがある場合のシフト
2. run1のみデータがある場合のシフト
3. 空の世代がある場合のシフト
4. 7世代すべてデータがある場合のシフト

#### UT-004: データ移行関数のテスト
**目的**: 既存データの移行処理が正しく行われることを確認
**テストケース**:
1. run1からrun3までのデータをそのまま保持
2. run4からrun7は空欄として初期化
3. データの整合性チェック

### 2. 統合テスト

#### IT-001: PageSummary更新処理の統合テスト
**目的**: 7世代の履歴が正しく更新されることを確認
**シナリオ**:
1. 新規ページの初回実行
2. 7回連続での実行
3. 8回目の実行（最古データの削除確認）
4. 連続実行でのシフト動作確認

#### IT-002: データ移行の統合テスト
**目的**: 既存データの移行が正しく行われることを確認
**シナリオ**:
1. 3世代データが存在する状態での初回実行
2. 部分的なデータが存在する状態での移行
3. 移行後の追加実行

#### IT-003: 大量データでのパフォーマンステスト
**目的**: 1000件以上のページURLでの処理時間を確認
**測定項目**:
- 更新処理時間
- 取得処理時間
- メモリ使用量

### 3. E2Eテスト

#### E2E-001: 実環境での7世代運用テスト
**目的**: 実際のスプレッドシートで7世代の運用を確認
**手順**:
1. テスト用スプレッドシートを準備
2. 7回連続で実行
3. 8回目に最古データが削除されることを確認

#### E2E-002: 既存環境でのデータ移行テスト
**目的**: 本番相当の環境でデータ移行を確認
**手順**:
1. 3世代データを持つスプレッドシートを準備
2. 新バージョンを適用
3. データが正しく移行されることを確認

#### E2E-003: クライアント側の影響確認テスト
**目的**: Summaryシートの表示が正しいことを確認
**確認項目**:
- IMPORTRANGEが正しく動作すること
- 7世代のデータが表示されること
- 列の並びが正しいこと

### 4. 無影響確認テスト

#### NI-001: PageHistory機能の無影響確認
**目的**: PageHistoryシートへの記録が影響を受けないことを確認
**確認項目**:
- 実行ごとに履歴が追加されること
- データ形式が変わらないこと

#### NI-002: ChangesHistory機能の無影響確認
**目的**: ChangesHistoryの5日間管理が影響を受けないことを確認
**確認項目**:
- 処理完了時の転写が正常に動作すること
- 5日経過後の削除が正常に動作すること

#### NI-003: PDF検出機能の無影響確認
**目的**: PDF検出・ダウンロード機能が影響を受けないことを確認
**確認項目**:
- PDFの検出が正常に動作すること
- 検出結果の記録が正常であること

## テストケース一覧

### 正常系テストケース

| ID | テストケース | 期待結果 |
|---|---|---|
| TC-001 | 新規ページの7回実行 | 7世代の履歴が正しく保存される |
| TC-002 | 8回目の実行 | 最古のデータが削除され、7世代のみ保持される |
| TC-003 | 連続実行 | 実行ごとにデータが正しくシフトされる |
| TC-004 | 3世代データの移行 | run1→run1、run2→run2、run3→run3に正しく移行される |
| TC-005 | 空きがある状態での実行 | 空きの世代があっても正しくシフトされる |

### 異常系テストケース

| ID | テストケース | 期待結果 |
|---|---|---|
| TC-101 | 不正な日付データ | エラーログを出力し、処理を継続 |
| TC-102 | 列数不足のシート | 自動的に列を拡張して処理 |
| TC-103 | 移行失敗時 | エラーログを出力し、元データを保持 |
| TC-104 | メモリ不足 | 適切なエラーメッセージとともに処理中断 |

### 境界値テストケース

| ID | テストケース | 期待結果 |
|---|---|---|
| TC-201 | 7世代目のデータ | 保持される |
| TC-202 | 8世代目のデータ | 削除される |
| TC-203 | 0件のデータ | エラーなく処理完了 |
| TC-204 | 1000件のページURL | 6分以内に処理完了 |

## 合格基準

### 機能要件
1. 7世代の履歴が正しく保存されること
2. 8回目の実行で最古のデータが自動削除されること
3. 既存の3世代データが正しく移行されること
4. 実行ごとにデータが正しくシフトされること

### 非機能要件
1. 1000件のページURLで処理時間が従来の150%以内
2. メモリ使用量が従来の200%以内
3. 既存機能への影響がないこと
4. エラー発生時も処理が継続されること

### 品質基準
1. すべての単体テストが合格
2. すべての統合テストが合格
3. E2Eテストで重大な問題がないこと
4. コードカバレッジ80%以上

## テスト環境

### 必要な環境
- Google Apps Script実行環境
- テスト用Googleスプレッドシート（マスター）
- テスト用Googleスプレッドシート（クライアント）
- 十分な実行時間枠（6分×複数回）

### テストデータ
- 3世代形式の既存データ
- 様々な実行パターンのテストデータ
- 1000件規模のページURLリスト

## 実施したテストの詳細結果

### 実行1（18:01）
- **処理ページ数**: 5
- **追加PDF数**: 108
- **処理時間**: 6.132秒
- **結果**: 初期データ投入成功、実行1列にデータ記録

### 実行2（18:16）
- **処理ページ数**: 4
- **追加PDF数**: 2
- **処理時間**: 6.436秒
- **結果**: 世代シフト確認（実行1→実行2）

### 実行3（18:49）
- **処理ページ数**: 4
- **追加PDF数**: 18
- **処理時間**: 8.172秒
- **結果**: 3世代分のデータ保持確認

### 実行4（19:09）
- **処理ページ数**: 5
- **追加PDF数**: 1
- **処理時間**: 9.924秒
- **結果**: 4世代分のデータ保持確認

### 実行5（19:15）
- **処理ページ数**: 5
- **追加PDF数**: 3
- **処理時間**: 6.749秒
- **結果**: 5世代分のデータ保持確認、PDF全削除→再活性化テスト成功

### 実行6（19:19）
- **処理ページ数**: 5
- **追加PDF数**: 3
- **処理時間**: 6.811秒
- **結果**: 6世代分のデータ保持確認

### 実行7（19:23）
- **処理ページ数**: 6
- **追加PDF数**: 2
- **処理時間**: 6.773秒（合計）
- **結果**: 7世代フル達成

### 実行8（19:28）
- **処理ページ数**: 7
- **追加PDF数**: 25
- **処理時間**: 7.584秒（合計）
- **結果**: 最古データ（18:01）削除確認、7世代のみ保持

## リスクと対策

### リスク1: 本番データの破壊
**対策**: 
- テスト専用環境での実施
- バックアップの事前取得

### リスク2: 実行時間制限による中断
**対策**:
- 小規模データでの初期テスト
- 段階的なデータ量増加

### リスク3: 他の開発との競合
**対策**:
- 専用ブランチでの開発・テスト
- マージ前の再テスト