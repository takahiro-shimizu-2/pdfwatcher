# PageSummary履歴管理拡張 テスト仕様書

## 概要
PageSummaryの履歴管理を3世代から7日分へ拡張する機能のテスト仕様書です。

**関連ドキュメント:**
- 設計書: `../../summary_history_extension_design.md`
- TODO: `../../TODOリスト/summary_history_extension_TODO.md`
- テストTODO: `summary_history_extension_test_TODO.md`

## テスト概要

### テスト目的
1. 7日分の履歴が正しく保存・管理されることを確認
2. 既存の3世代データが正しく移行されることを確認
3. 7日以上経過したデータが自動削除されることを確認
4. 既存機能への影響がないことを確認
5. パフォーマンスの大幅な低下がないことを確認

### テスト範囲
- **影響を受ける機能**
  - PageSummaryの更新処理
  - PageSummaryの取得処理
  - データ移行処理
  - Summaryシートの表示

- **影響を受けない機能（無影響確認）**
  - PageHistory（全履歴）の記録
  - ChangesHistory（5日間履歴）の管理
  - RunLogの記録
  - PDF検出・ダウンロード機能
  - その他の既存機能

## テスト仕様

### 1. 単体テスト

#### UT-001: PageSummaryモデルのテスト
**目的**: 新しいデータ構造が正しく定義されていることを確認
**前提条件**: TypeScriptのコンパイルが成功すること
**テスト項目**:
- `dailyRuns`プロパティが配列型であること
- `RunSummary`型の要素を格納できること
- 旧プロパティ（run1, run2, run3）が存在しないこと

#### UT-002: データ変換関数のテスト
**目的**: 3世代形式から7日分形式への変換が正しく行われることを確認
**テストケース**:
1. 完全な3世代データの変換
2. 一部欠損した3世代データの変換
3. 空のデータの変換
4. 不正な形式のデータのエラーハンドリング

#### UT-003: 日付計算関数のテスト
**目的**: 7日以内の判定が正しく行われることを確認
**テストケース**:
1. 当日のデータ → 保持
2. 6日前のデータ → 保持
3. 7日前のデータ → 削除
4. 8日以上前のデータ → 削除
5. 未来の日付のデータ → エラー

#### UT-004: 同一日付マージ関数のテスト
**目的**: 同一日の複数データが正しくマージされることを確認
**テストケース**:
1. 異なる時刻の同一日データ → 最新のみ保持
2. 複数日のデータ → それぞれ保持
3. 時刻情報なしのデータ → 適切な処理

### 2. 統合テスト

#### IT-001: PageSummary更新処理の統合テスト
**目的**: 7日分の履歴が正しく更新されることを確認
**シナリオ**:
1. 新規ページの初回実行
2. 7日間連続での実行
3. 8日目の実行（最古データの削除確認）
4. 同一日に複数回実行

#### IT-002: データ移行の統合テスト
**目的**: 既存データの移行が正しく行われることを確認
**シナリオ**:
1. 3世代データが存在する状態での初回実行
2. 部分的なデータが存在する状態での移行
3. 移行後の追加実行

#### IT-003: 大量データでのパフォーマンステスト
**目的**: 1000件以上のページURLでの処理時間を確認
**測定項目**:
- 更新処理時間
- 取得処理時間
- メモリ使用量

### 3. E2Eテスト

#### E2E-001: 実環境での7日間運用テスト
**目的**: 実際のスプレッドシートで7日間の運用を確認
**手順**:
1. テスト用スプレッドシートを準備
2. 7日間、毎日1回実行
3. 8日目に最古データが削除されることを確認

#### E2E-002: 既存環境でのデータ移行テスト
**目的**: 本番相当の環境でデータ移行を確認
**手順**:
1. 3世代データを持つスプレッドシートを準備
2. 新バージョンを適用
3. データが正しく移行されることを確認

#### E2E-003: クライアント側の影響確認テスト
**目的**: Summaryシートの表示が正しいことを確認
**確認項目**:
- IMPORTRANGEが正しく動作すること
- 7日分のデータが表示されること
- 列の並びが正しいこと

### 4. 無影響確認テスト

#### NI-001: PageHistory機能の無影響確認
**目的**: PageHistoryシートへの記録が影響を受けないことを確認
**確認項目**:
- 実行ごとに履歴が追加されること
- データ形式が変わらないこと

#### NI-002: ChangesHistory機能の無影響確認
**目的**: ChangesHistoryの5日間管理が影響を受けないことを確認
**確認項目**:
- 処理完了時の転写が正常に動作すること
- 5日経過後の削除が正常に動作すること

#### NI-003: PDF検出機能の無影響確認
**目的**: PDF検出・ダウンロード機能が影響を受けないことを確認
**確認項目**:
- PDFの検出が正常に動作すること
- 検出結果の記録が正常であること

## テストケース一覧

### 正常系テストケース

| ID | テストケース | 期待結果 |
|---|---|---|
| TC-001 | 新規ページの7日間実行 | 7日分の履歴が正しく保存される |
| TC-002 | 8日目の実行 | 最古のデータが削除され、7日分のみ保持される |
| TC-003 | 同一日の複数回実行 | その日の最新データのみが保持される |
| TC-004 | 3世代データの移行 | run1→Day1、run2→Day2、run3→Day3に正しく移行される |
| TC-005 | 空きがある状態での実行 | 空きを詰めて最新7日分が保持される |

### 異常系テストケース

| ID | テストケース | 期待結果 |
|---|---|---|
| TC-101 | 不正な日付データ | エラーログを出力し、処理を継続 |
| TC-102 | 列数不足のシート | 自動的に列を拡張して処理 |
| TC-103 | 移行失敗時 | エラーログを出力し、元データを保持 |
| TC-104 | メモリ不足 | 適切なエラーメッセージとともに処理中断 |

### 境界値テストケース

| ID | テストケース | 期待結果 |
|---|---|---|
| TC-201 | 7日目のデータ | 保持される |
| TC-202 | 8日目のデータ | 削除される |
| TC-203 | 0件のデータ | エラーなく処理完了 |
| TC-204 | 1000件のページURL | 6分以内に処理完了 |

## 合格基準

### 機能要件
1. 7日分の履歴が正しく保存されること
2. 8日以上経過したデータが自動削除されること
3. 既存の3世代データが正しく移行されること
4. 同一日の重複データが適切に処理されること

### 非機能要件
1. 1000件のページURLで処理時間が従来の150%以内
2. メモリ使用量が従来の200%以内
3. 既存機能への影響がないこと
4. エラー発生時も処理が継続されること

### 品質基準
1. すべての単体テストが合格
2. すべての統合テストが合格
3. E2Eテストで重大な問題がないこと
4. コードカバレッジ80%以上

## テスト環境

### 必要な環境
- Google Apps Script実行環境
- テスト用Googleスプレッドシート（マスター）
- テスト用Googleスプレッドシート（クライアント）
- 十分な実行時間枠（6分×複数回）

### テストデータ
- 3世代形式の既存データ
- 様々な日付パターンのテストデータ
- 1000件規模のページURLリスト

## リスクと対策

### リスク1: 本番データの破壊
**対策**: 
- テスト専用環境での実施
- バックアップの事前取得

### リスク2: 実行時間制限による中断
**対策**:
- 小規模データでの初期テスト
- 段階的なデータ量増加

### リスク3: 他の開発との競合
**対策**:
- 専用ブランチでの開発・テスト
- マージ前の再テスト