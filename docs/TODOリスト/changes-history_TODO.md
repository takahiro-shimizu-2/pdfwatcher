# Changes履歴保存機能 実装TODOリスト

## 概要
Changes履歴保存機能の実装に必要なタスクのTODOリスト。

## 関連ドキュメント
- 設計書: [changes-history_design.md](./changes-history_design.md)
- テスト仕様書: [changes-history_test.md](../test/changes-history/changes-history_test.md)
- テストTODOリスト: [changes-history_test_TODO.md](../test/changes-history/changes-history_test_TODO.md)

## Phase 1: 基盤実装（必須機能）

### 1.1 履歴管理モジュールの作成
- [ ] `client-gas/src/c-13-history-manager.ts`を新規作成
- [ ] 基本的な型定義を追加（ChangesHistoryEntry型）
- [ ] モジュールの基本構造を実装

### 1.2 転写機能の実装
- [ ] `transferChangesToHistory()`関数を実装
  - [ ] Changesシートからデータ読み取り処理
  - [ ] SavedAt、RunId、ExpiresAtの付与処理
  - [ ] ChangesHistoryシートへのバッチ書き込み処理
  - [ ] エラーハンドリング（転写失敗時のログ出力）
- [ ] ChangesHistoryシートの自動作成機能を実装
  - [ ] シート存在チェック
  - [ ] ヘッダー行の設定

### 1.3 期限切れデータ削除機能の実装
- [ ] `deleteExpiredHistory()`関数を実装
  - [ ] ChangesHistoryシートの全データ読み取り
  - [ ] 期限切れデータの判定ロジック
  - [ ] バッチ削除処理の実装
  - [ ] エラーハンドリング（削除失敗時のログ出力）

### 1.4 処理完了時の統合
- [ ] `client-gas/src/c-05-main.ts`の修正
  - [ ] processGroups関数内の完了判定部分を特定
  - [ ] 完了時（currentGroup >= totalGroups）に転写・削除処理を追加
  - [ ] 処理時間の計測とログ出力
  - [ ] エラー時の処理継続確保
  - [ ] 6分制限での中断時は転写しないことを確認

## Phase 2: 品質向上（推奨機能）

### 2.1 ユーティリティ関数の実装
- [ ] 日付フォーマット関数の実装
- [ ] RunId生成関数の改善（既存のものを活用）
- [ ] バッチ処理用のヘルパー関数

### 2.2 ログ機能の強化
- [ ] UserLogシートへの履歴管理情報の記録
  - [ ] 転写件数の記録
  - [ ] 削除件数の記録
  - [ ] 処理時間の記録

### 2.3 パフォーマンス最適化
- [ ] データ読み取りの最適化（必要なカラムのみ）
- [ ] 削除処理の最適化（ソート済みデータでの処理）

## Phase 3: テスト実装

### 3.1 単体テストの作成
- [ ] history-manager.tsの単体テスト
  - [ ] 転写処理のテスト
  - [ ] 削除処理のテスト
  - [ ] エラーケースのテスト

### 3.2 統合テストの実施
- [ ] processGroups完了時の統合テスト
- [ ] 6分制限シナリオでのテスト（中断時は転写されないことを確認）
- [ ] 大量データでのパフォーマンステスト
- [ ] 継続実行完了時の転写確認

## Phase 4: ドキュメント更新

### 4.1 ユーザードキュメント
- [ ] README.mdへの機能追加説明
- [ ] 使用方法の追記

### 4.2 開発ドキュメント
- [ ] 開発ガイド.mdへの追記
- [ ] APIドキュメントの更新（必要に応じて）

## 実装優先順位

1. **高優先度**（必須）
   - Phase 1のすべてのタスク
   - Phase 3.2の統合テスト

2. **中優先度**（推奨）
   - Phase 2.1, 2.2のタスク
   - Phase 3.1の単体テスト

3. **低優先度**（オプション）
   - Phase 2.3のパフォーマンス最適化
   - Phase 4のドキュメント更新

## 実装時の注意事項

1. **GAS制約の考慮**
   - import/export文は使用不可
   - グローバル変数として関数を定義
   - ES5互換のコードを記述

2. **パフォーマンス**
   - SpreadsheetApp.flush()の使用を最小限に
   - バッチ操作を活用
   - 不要なシート読み取りを避ける

3. **エラーハンドリング**
   - 履歴管理のエラーで本処理を止めない
   - すべてのエラーをログ出力
   - シート不在時の自動作成

4. **データ整合性**
   - トランザクション的な処理は不可（GAS制約）
   - 部分的な成功を許容する設計
   - 重複データの防止策

## 完了条件

- [ ] すべての高優先度タスクが完了
- [ ] テストがすべてパス
- [ ] パフォーマンスへの影響が0.5秒以内
- [ ] コードレビューの完了